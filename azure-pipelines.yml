trigger:
- main

pool:
  vmImage: ubuntu-latest

variables:
  EC2_HOST: 'your-ec2-public-ip'
  EC2_USER: 'ubuntu'
  PEM_FILE: 'aws-ec2-key.pem'

stages:
- stage: Deploy
  jobs:
  - job: DeployGoApp
    steps:
    - task: UsePythonVersion@0
      inputs:
        versionSpec: '3.x'

    - script: |
        echo "Setting up SSH"
        mkdir -p ~/.ssh
        echo "$(PEM_CONTENT)" > ~/.ssh/${PEM_FILE}
        chmod 600 ~/.ssh/${PEM_FILE}
      displayName: 'Prepare SSH'

    - task: CopyFilesOverSSH@0
      inputs:
        sshEndpoint: 'tfPortal-microservices-dev-aws-ec2-deploy'
        sourceFolder: '$(Build.SourcesDirectory)/GoProject'
        contents: '**'
        targetFolder: '~/tfPortal-microservices-dev'

    - script: |
        ssh -o StrictHostKeyChecking=no -i ~/.ssh/${PEM_FILE} $(EC2_USER)@$(EC2_HOST) <<EOF
        cd ~/tfPortal-microservices-dev
        nohup go run main.go > app.log 2>&1 &
        EOF
      displayName: 'Start App on EC2'
