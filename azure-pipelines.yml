trigger:
- main

pool:
  name: tfPortal-ms-aws-self-hosted
  demands:
    - Agent.Name -equals tfPortal-ms-dev

variables:
  EC2_HOST: '54.242.162.37'
  EC2_USER: 'ubuntu'
  PEM_FILE: 'aws-ec2-key.pem'

stages:
- stage: Deploy
  displayName: ðŸš€ Deploy Go App to EC2
  jobs:
  - job: DeployGoApp
    displayName: ðŸ“¦ DeployGoApp
    steps:

    - checkout: self

    - task: Bash@3
      displayName: 'ðŸ” Decode & Write SSH Key'
      inputs:
        targetType: inline
        script: |
          echo "ðŸ” Writing PEM to ~/.ssh"
          mkdir -p ~/.ssh
          echo "$PEM_BASE64" | base64 -d > ~/.ssh/${PEM_FILE}
          chmod 600 ~/.ssh/${PEM_FILE}
          eval "$(ssh-agent -s)"
          ssh-add ~/.ssh/${PEM_FILE}
      env:
        PEM_BASE64: $(PEM_BASE64)

    - script: |
        echo "ðŸ“¦ Installing rsync if missing"
        which rsync || (sudo apt-get update && sudo apt-get install -y rsync)

        echo "ðŸ“‚ Syncing project to EC2 using rsync"
        rsync -avz -e "ssh -i ~/.ssh/${PEM_FILE} -o StrictHostKeyChecking=no" \
          --exclude '.git' \
          --exclude '*.log' \
          --exclude 'node_modules' \
          $(Build.SourcesDirectory)/ ${EC2_USER}@${EC2_HOST}:~/tfPortal-microservices-dev
      displayName: 'ðŸ“‚ Copy Files to EC2 (rsync)'

    - script: |
        echo "ðŸš€ Starting Go microservices on EC2 with setsid and logging"
        ssh -i ~/.ssh/${PEM_FILE} -o StrictHostKeyChecking=no ${EC2_USER}@${EC2_HOST} <<'EOF'
        set -e

        echo "ðŸ”„ Killing existing Go processes..."
        pkill -f main || true

        echo "â–¶ï¸ Starting user_service..."
        cd ~/tfPortal-microservices-dev/GoProject/user_service
        nohup setsid go run main.go > user_app.log 2> user_app.err < /dev/null &
        sleep 2
        echo "ðŸ“œ user_service status:"
        ps aux | grep "[m]ain.go"
        cat user_app.err || echo "â„¹ï¸ No errors in user_app.err"

        echo "â–¶ï¸ Starting post_service..."
        cd ~/tfPortal-microservices-dev/GoProject/post_service
        nohup setsid go run main.go > post_app.log 2> post_app.err < /dev/null &
        sleep 2
        echo "ðŸ“œ post_service status:"
        ps aux | grep "[m]ain.go"
        cat post_app.err || echo "â„¹ï¸ No errors in post_app.err"

        echo "âœ… Microservices deployed and started"
        EOF
      displayName: 'âš™ï¸ Run & Log Go Microservices on EC2'
