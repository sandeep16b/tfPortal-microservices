trigger:
- main

pool:
  name: tfPortal-ms-aws-self-hosted
  demands:
    - Agent.Name -equals tfPortal-ms-dev

variables:
  EC2_HOST: '54.242.162.37'       # Replace with your actual EC2 IP
  EC2_USER: 'ubuntu'
  PEM_FILE: 'aws-ec2-key.pem'
  PEM_CONTENT: $(PEM_CONTENT)

stages:
- stage: Deploy
  displayName: ğŸš€ Deploy Go App to EC2
  jobs:
  - job: DeployGoApp
    steps:

    - script: |
        echo "ğŸ” Setting up SSH credentials"
        mkdir -p ~/.ssh
        echo "$(PEM_CONTENT)" > ~/.ssh/$(PEM_FILE)
        chmod 600 ~/.ssh/$(PEM_FILE)
        eval "$(ssh-agent -s)"
        ssh-add ~/.ssh/$(PEM_FILE)
      displayName: 'ğŸ”§ Prepare SSH Key'

    - script: |
        echo "ğŸ“‚ Copying Go project files to EC2"
        scp -i ~/.ssh/$(PEM_FILE) -o StrictHostKeyChecking=no -r ./GoProject $(EC2_USER)@$(EC2_HOST):~/tfPortal-microservices-dev
      displayName: 'ğŸ“¦ Copy Files to EC2'

    - script: |
        echo "ğŸš€ Starting Go App on EC2"
        ssh -i ~/.ssh/$(PEM_FILE) -o StrictHostKeyChecking=no $(EC2_USER)@$(EC2_HOST) <<EOF
        pkill -f main || true
        cd ~/tfPortal-microservices-dev
        nohup go run main.go > app.log 2>&1 &
        EOF
      displayName: 'âš™ï¸ Run Go App on EC2'
