trigger:
- main

pool:
  name: tfPortal-ms-aws-self-hosted
  demands:
    - Agent.Name -equals tfPortal-ms-dev

variables:
  EC2_HOST: '54.242.162.37'
  EC2_USER: 'ubuntu'
  PEM_FILE: 'aws-ec2-key.pem'

stages:
- stage: Deploy
  displayName: üöÄ Deploy Go App to EC2
  jobs:
  - job: DeployGoApp
    displayName: üì¶ DeployGoApp
    steps:

    - checkout: self

    - task: Bash@3
      displayName: 'üîê Decode & Write SSH Key'
      inputs:
        targetType: inline
        script: |
          echo "üîê Writing PEM to ~/.ssh"
          mkdir -p ~/.ssh
          echo "$PEM_BASE64" | base64 -d > ~/.ssh/${PEM_FILE}
          chmod 600 ~/.ssh/${PEM_FILE}
          eval "$(ssh-agent -s)"
          ssh-add ~/.ssh/${PEM_FILE}
      env:
        PEM_BASE64: $(PEM_BASE64)

    - script: |
        echo "üì¶ Installing rsync if missing"
        which rsync || (sudo apt-get update && sudo apt-get install -y rsync)

        echo "üìÇ Syncing project to EC2 using rsync"
        rsync -avz -e "ssh -i ~/.ssh/${PEM_FILE} -o StrictHostKeyChecking=no" \
          --exclude '.git' \
          --exclude '*.log' \
          --exclude 'node_modules' \
          $(Build.SourcesDirectory)/ ${EC2_USER}@${EC2_HOST}:~/tfPortal-microservices-dev
      displayName: 'üìÇ Copy Files to EC2 (rsync)'

    - script: |
        echo "üöÄ Starting Go microservices on EC2"
        ssh -i ~/.ssh/${PEM_FILE} -o StrictHostKeyChecking=no ${EC2_USER}@${EC2_HOST} <<EOF
        pkill -f main || true
        cd ~/tfPortal-microservices-dev/GoProject/user_service
        nohup go run main.go > user_app.log 2>&1 &
        cd ~/tfPortal-microservices-dev/GoProject/post_service
        nohup go run main.go > post_app.log 2>&1 &
        EOF
      displayName: '‚öôÔ∏è Run Both Go Microservices'
